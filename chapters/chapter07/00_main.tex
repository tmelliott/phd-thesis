\chapter{Discussion}
\label{cha:discussion}

\phantom{\gls{gtfs}\gls{gtfs}\gls{gtfs}}
\phantom{\gls{gps}\gls{gps}\gls{gps}}
\phantom{\gls{api}\gls{api}\gls{api}}

Accurately predicting the arrival time of transit vehicles involves estimating many unknowable factors, and is inevitably prone to high levels of uncertainty. We set out to develop a real-time application framework that sits on top of \gls{gtfs}---a globally used transit data format---allowing estimation of \emph{network traffic state} to make arrival time predictions more useful for travellers. Our results demonstrate that the proposed \emph{particle filter} method provides the ability to both estimate network state and predict arrival time distributions better, on average, than the currently deployed method. By estimating the full \gls{cdf}, we can provide quantile-based prediction intervals, but also compute probabilities for journey planning problems, such as the chance of arriving at the destination on time.


It is clear from the literature that successful arrival time prediction requires some form of \emph{traffic state estimation}, be it based on historical trends \citep{Julio_2016,Cathey_2003,Celan_2017,Mazloumi_2012} or real-time information \citep{Ma_2019,Xinghao_2013,Shalaby_2004}. However, one of our aims was to build on top of \gls{gtfs} and require no additional information (such as taxi data) which led us to construct a \emph{transit network}, allowing us to model real-time traffic conditions using the transit vehicles themselves.


Our application uses stops as the nodes, and road segments are identified for each route by their unique sequence of stops. This is similar to the network described by \citet{Celan_2018, Celan_2017}; however, while they showed that including stops is necessary for accurate arrival prediction, they also demonstrated the need for other potential time barriers---for example, roundabouts or pedestrian crossings---which we do not yet have implemented. Nevertheless, other methods have also used links between stops, often incorporating multiple stops in each link \citep{Shalaby_2004}.


Having expressed each route as a sequence of segments which each correspond to a unique one-directional road between stops, it is trivial to assign a vehicle's current or previous location to roads throughout the network. In this way, our framework allows the estimation of not only vehicle speeds, but also of the average speed of vehicles along individual roads. We chose \emph{average vehicle speed} similarly to \citet{Celan_2017, Celan_2018} instead of travel time \citep{Shalaby_2004, Dai_2019} as the latter tends to have long tails (the \kf{} assumes the state is Gaussian, and from our observations found that speeds are more symmetric than travel time). The process of predicting arrival times that incorporate real-time traffic conditions involves three main phases: vehicle modelling to estimate vehicle state and road speeds; network modelling to update network state; and arrival time prediction.


Modelling transit vehicles involves handling vehicle behaviour and other unique features of transit data along with measurement uncertainties and irregularities. We use a particle filter to estimate vehicle state due to its superior handling of \emph{multimodality}, which is common in transit data. It also allows for many trajectories to be explored \citep{Hans_2015}, which is particularly an issue under low observation frequency. Not only this, however, but the particle filter allows for a more generalised transition function which can implement the complex behaviour we describe, which includes stopping behaviours at stops and intersections. Using a particle filter to estimate vehicle state provides a straightforward way of estimating vehicle speeds along roads. By expressing each route as a sequence of \emph{road segments}, each particle's travel time along each segment can be calculated. Then, using the Dirac delta measure, the vehicle's estimated average speed along individual segments is obtained with associated uncertainty.


The primary advantage of developing the transit network is that the vehicle speed estimates are assigned to \emph{roads}, rather than links along a given route. In contrast, other methods either only apply to a given route \citep{Yu_2010,Celan_2017,Chang_2010}, or require manual identification of common road segments \citep{Yu_2011,Yin_2017}.


Our particle filter implementation also uses a unique \emph{likelihood function} which, unlike other methods we have seen, allows the particle observations to be compared directly to the observation. Historically this step required the ``snapping'' of \gls{gps} observations to the nearest point along a route to estimate the vehicle's \emph{trip-distance-travelled}, as \citet{Cathey_2003} describe in detail. Our approach removes this unnecessary source of uncertainty, which is of particular importance where routes may ``loop'': given a single observation it is impossible to tell whether the bus is entering or exiting the loop (\cref{fig:lhood_obs}, \cpageref{fig:lhood_obs}). We also use \emph{arrival} and \emph{departure times} in the likelihood---where available---to reduce the number of possible trajectories which occur in the vicinity of bus stops (\cref{fig:tu_update}, \cpageref{fig:tu_update}).


One aspect we have not explored entirely is real-time \emph{dwell-time modelling}. \citet{Shalaby_2004} demonstrated its significance, as did \citet{Hans_2015}; however, their applications had access to \gls{apc} data, which is not available in Auckland. Instead, we chose to use historical estimates of dwell time (computed from arrival and departure data) to obtain a dwell-time distribution for each stop along a route. In doing so, we noted a peculiarity with the data in which dwell times seem to display a 9-second frequency.


Other issues with the Auckland real-time data can be attributed to \emph{way points}, which can result in the bus appearing to go backwards. To minimise the impact of this, we pre-process each observation to detect if it might be erroneous or ``pre-emptive'', and in those cases ignore it altogether. This issue has not been mentioned in any of the literature, so it might very well only affect Auckland.


Given the ability to \emph{observe} the speeds of vehicles as they travel along roads, it becomes possible to model the transit road network's state in real-time. We use a Kalman filter to model the state (average vehicle speed) of roads throughout Auckland's public transport network. Previous research by \citet{Shalaby_2004} demonstrated the ability of the \kf{} to react to real-time traffic events, a result which we were also able to demonstrate. This approach can be contrasted with alternatives which use ``real-time'' information to choose from historical trends, as demonstrated by the likes of \citet{Chen_2014,Julio_2016,Yu_2010,Yu_2011,Celan_2017} who used machine learning methods (\gls{ann} or \gls{svm}) to predict travel times or speeds. \Citet{Yin_2017} demonstrated the difficulty of these types of methods to respond to sudden, large increases in travel time during peak times.


At the end of \cref{cha:network_model}, I demonstrated the use of a simple forecasting method to predict road speeds based on the current state and historical trends. This forecasting approach predicted road speed better than the na\"ive ``current state'' prediction. More research is required in this area, however, particularly on the notion of \emph{relationships} or \emph{correlations} between road segments, particularly at peak times. In such cases, a \emph{traffic shockwave} model similar to that employed by \citet{Julio_2016} might be appropriate.


Under the current implementation of our particle filter, speeds tend to be overestimated, mostly due to arrival and departure time uncertainty. Particles tend to \emph{travel faster} and \emph{spend longer} at stops than the bus does, which could be improved by implementing a more restrictive likelihood on the arrival and departure time observations. It may also require some exploration of the ``9-second'' phenomenon and how it may be affecting the reliability of arrival and departure time observations.


Regardless, the real-time network state plays a critical role in arrival time prediction, as this has time and again been shown to contribute to uncertainty \citep{Shalaby_2004, Yu_2006, Yu_2010, Yu_2011, Julio_2016}. Not only this, but the network state may also be useful to transit providers as a way of monitoring real-time congestion which may be affecting service punctuality (on-time arrival). The primary use of network state, however, is for real-time arrival time prediction.


The primary goal of this thesis is to demonstrate how using real-time traffic information can be used to improve the reliability of arrival time prediction. Vehicle state (as approximated by a set of particles) is combined with network state and historically-based dwell-time distributions to obtain estimates of arrival time at all upcoming stops. Unlike many previous approaches, we are not limited to predicting only a single stop \citep{Yu_2011}. Since the nature of the application requires distribution of arrival time predictions to travellers, I demonstrate a simple, fast method for computing the full \gls{cdf} of arrival time by rounding all particles' estimates to integer-minutes. This significantly reduces the complexity of computing and storing the arrival time \glspl{cdf}, and allows quantile estimates and event probabilities to be calculated directly on a user's phone.


The advantages of providing a probabilistic distribution of arrival time versus a point estimate is that best- versus worst-case scenarios can be evaluated. If you are meeting a friend in town for a coffee, the cost of missing the bus is not very high---you can text your friend that you are running late (and maybe shout them a muffin). However, if you have a job interview or an apartment viewing you cannot be late for, you want to know with more certainty that the bus will be on time. The arrival time distribution allows travellers to make decisions: if the bus only has a 70\% chance of getting you to your job interview on time, you might decide to catch a taxi instead. Previous research by \citet{Fernandes_2018} supports the idea that people can make more informed decisions given uncertainty information. Besides, point estimates can still be computed from the \gls{cdf} for those who prefer them.


Of course, the uncertainty is still problematic, and ideally as much as possible should be reduced. Road speed contributes in part to uncertainty, but there is also a significant amount attributed to dwell times, which we have no formal model for due to a lack of associated data. However, another problematic situation is \emph{layovers}, which, as I demonstrated, are poorly maintained by drivers. This contributes to uncertainty, particularly for a route that is running early: we cannot assume the driver will stop. Thankfully, the particle filter makes this scenario easy to handle by merely allowing each particle an independent chance of waiting (which we obtain from observing historical departure delays, \cref{fig:layover_observance}, \cpageref{fig:layover_observance}). Thus, the ``best'' and ``worst'' case scenarios are when the driver does and does not stop, respectively. This concurs with discussions by \citet{Hans_2015,Ulmke_2006} noting the particle filter's ability to handle multimodality in the vehicle's trajectory.


One issue impacting the predictive performance of our method is the \emph{overestimation} of road speeds. This results in arrival time estimates that are earlier than they should be, which we saw in \cref{cha:etas} with the 60\% quantile having the smallest absolute error, although some of this can be attributed to \emph{rounding down} to obtain the \gls{cdf}. These issues were particularly noticeable during peak times when traffic conditions are more volatile. We also noticed that often not enough uncertainty was included during peak time: the upper quantile of arrival time, notably concerning journey planning, was frequently too low, resulting in underestimates of the probability that the bus would arrive on time. While not ideal, I believe that this is a better predicament to be in than the other way around, where arrival time predictions are \emph{later} than they should be and could lead a passenger to miss their bus.


As far as we know, no other framework provides the full \gls{cdf} of arrival times. Work such as that by \citet{Celan_2017, Celan_2018} presents the possibility for more comprehensive journey planning that uses a probabilistic model of arrival times our application provides. In this situation, a database containing the arrival time distribution could be queried by a journey planning application, which finds candidate routes from the network and computes the probabilities of their success. Most importantly, this uses the \emph{real-time} predictions, rather than scheduled travel and arrival times, which are often unreliable.


The combination of the particle filter to model vehicles with the real-time network state and dwell time distributions allows our application to predict arrival times more accurately and more reliably than the method currently used by Auckland Transport and likely many other agencies around the world. Our application provides a foundation for further research, for example, for more advanced dwell time or travel time models. Of course, any such work must also consider the computational constraints of real-time applications.


Besides reliability, our main concern while developing this application was its real-time feasibility: \emph{is it fast enough for real-time use?} Therefore, we made several important decisions early on, namely using \Cpp{} through \pkg{Rcpp} \citep{Rcpp}, which resulted in the \Rstats{} package \pkg{transitr}. Our initial goal for an iteration time was \emph{ 30~seconds or faster}, and as I showed in \cref{sec:prediction_performance}, our application comes in well under that with most iterations taking 6--10~seconds using 3~cores on a desktop computer.\footnote{We do have access to an 8~core virtual machine, courtesy of the Center for e-Research at the University of Auckland, but were unable to run the simulations on it due to security configurations that I am still working around.}


Our application connects to a public \gls{gtfs} \gls{api} and fetches the data. 6--10~seconds later, arrival time estimates are available for travellers.\footnote{In theory; currently, because of the server's firewall and security settings, we are working on ways of making the data accessible.} To get an idea of the complexity of the task, let us say there are 1000~vehicles at peak time, each servicing routes with up to 40~or more stops. If we assume that the average number of \emph{remaining stops} per vehicle is 10, then we need to predict arrival times for 10,000 stops during each iteration; at peak time, this is about 1000~predictions per second. \citet{Chang_2010} developed a prediction method that could predict \emph{multiple stops ahead}, and they were able to make about 4000~predictions \emph{per minute}. Unfortunately, other methods did not report timings of their methods for us to compare ours with.


\section{Future work}

The foundation of our arrival time prediction framework is the \emph{transit network} constructed on top of \gls{gtfs} data. This could potentially be further generalised from using \emph{stops as nodes} to identifying overlapping shapes and, more importantly, the locations where non-overlapping routes join (that is, find intersections). Algorithms, such as those proposed by \citet{Xie_2016,Zhang_2017}, could be used to find intersection locations from the \gls{gtfs} shape data. This would improve the modelling capability as many of these intersections will affect vehicle speed as \citet{Celan_2017} describe, but would also completely reduce segment overlap. This would also mean that express routes (which use the same road but bypass some stops) could contribute to the road states and be able to use them for predictions. Other possibilities include using external data sources to identify intersections, such as OpenStreetMap \citep{OpenStreetMap_2017}.


Using a particle filter to model vehicle behaviour enables a vast array of possibilities, some of which I demonstrated in \cref{cha:vehicle_model}. The main feature is the likelihood, which can become a fairly complicated issue. We presented the distribution of vehicle distance from the shape path, and one theory for this is road width. From manual inspection, many of the shape paths run down the centre line of the road, so we would expect there to be a short distance between where the bus is and the shape location. For single-lane roads, this is about 1~meter, and 2.5--3~meters for double-lane roads. These are approximately the peaks we saw in \cref{fig:pf_param_gps} on \cpageref{fig:pf_param_gps}. It may be possible to model this behaviour, such that the actual vehicle location is offset slightly to the left of the shape path, potentially permitting the use of a smaller value for \gls{gps} error. Similarly, the arrival time and departure time likelihood could be modified such that the 9-second phasing is accounted for to reduce the possible range of trajectories further.


On the other hand, alternative types of data could also be included in the likelihood. Recently,\footnote{As of December 2019.} Auckland Transport began including vehicle speed and odometer readings for some vehicles, which could go a long way to improving the estimation of \emph{average} vehicle speed along roads, particularly for the issue of \emph{overestimated} speed (due to particles ``rushing'' to the stop). Further, such information could assist distinguishing between buses that have and have not stopped at a bus stop. Each trip update (arrival or departure) is associated with a vehicle position, which may contain speed information. If these are combined, we could detect the approximate speed of the vehicle at the time of reporting: if it is zero, this indicates the bus stopped; if it is greater than zero, it means that the bus \emph{possibly} did not stop. However, it is still unlikely to remove all uncertainty.


One component of the model that we pay less attention to is dwell time. In particular, a \emph{real-time} dwell time model could be based on passenger demand and \emph{time since the last service}. If available, \gls{apc} data could improve dwell time predictions, particularly for arrival time prediction, removing as much uncertainty as possible. At peak times, for example, there is a high chance of buses stopping at all stops, versus during the evening when they usually have only a few passengers.



In \cref{cha:network_model}, I explained our use of modelling road segments independently. However, this is not a realistic assumption, and not only could real-time predictions be improved by modelling them with a dependent structure, but so too could the accuracy of the network model itself. For example, observations of vehicle speed along a segment could have implications for adjacent segments, similar to the work presented by \citet{Julio_2016}. Alternatively, methods using particle filters to propose traffic state trajectories based on historical data, similar to the work of \citet{Chen_2014} for forecasting car travel times, could account for historical trends. Either way, I would predict any such improvement would have a positive effect on the accuracy of arrival time prediction, but not necessarily on the application timing---the \kf{} in our application takes less than 1~millisecond. Further, in the arrival time prediction component, forecasting each segment for each particle could become a very costly procedure.


\section{Concluding remarks}

The prediction of transit vehicle arrival time at upcoming stops in real-time is not quite as easy as it seems and is prone to uncertainty entering at all points throughout the process. Some of these uncertainties can be modelled: for example, travel time can be measured in real-time to better predict how long the bus will take. Some others are impossible (or too difficult) to model and predict accurately, such as traffic accidents. By using a real-time transit road network, our predictions can, however, react to these events quickly.


The more uncertainty that can be modelled, the more reliable our predictions will be, particularly when choosing to convey uncertainty to commuters. In particular, the \emph{lower quantile}, which is effectively an estimate of \emph{how early the bus might be}, can---for passengers who use the \gls{rti} to make decisions---maximise their chances of catching the bus. Further, it allows us to compute the probabilities of events, from ``the bus arrives on time'' to ``the transfer is successful''. Passengers who wish to make use of this information can make informed journey planning decisions, and in doing so, we hope that such results will improve their perception of public transport as previous studies have shown, and indeed increase ridership.
